name: Deploy Hugo Blog from GitLab to Cloudflare Pages

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout Code from GitLab (Using SSH or Token to handle submodules)
    # We combine the clone and setup steps for better access control.
    - name: Checkout Code with Submodule Authentication
      env:
        # Use a variable name that Git can easily interpret as a token
        GIT_OAUTH_TOKEN: ${{ secrets.GITLAB_ACCESS_TOKEN }} 
      run: |
        # 1a. Clone the repository first using the token
        git clone https://oauth2:$GIT_OAUTH_TOKEN@gitlab.com/tejasjog/blog.git
        
        # 1b. Change directory to the cloned repo
        cd blog
        
        # 1c. CRITICAL: Configure Git to replace all 'https://gitlab.com' 
        # URLs in the .gitmodules file with the authenticated token URL.
        # This ensures that git submodule update succeeds for private repos.
        git config --global url."https://oauth2:$GIT_OAUTH_TOKEN@gitlab.com".insteadOf "https://gitlab.com"
        
    # 2. Run Submodule Update and Cleanup .git files
    - name: Update Submodules and Cleanup Content Directories
      # working-directory must be 'blog' now
      working-directory: blog
      run: |
        echo "Attempting to update submodules..."
        # 2a. Update/initialize all submodules. This now uses the authenticated URL.
        git submodule update --init --recursive --force
  
        # 2b. CRITICAL: Remove the hidden .git directories from content submodules.
        # The 'themes/PaperMod' submodule is excluded as it needs its .git directory.
        find content/posts -name ".git" -type d -exec rm -rf {} +
        
        echo "Cleanup complete. Content submodules now look like regular folders."
  
    # 3. Setup Node.js 
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        
    # 4. Cache Node Modules
    # Note: Caching with /node_modules path is tricky unless using `setup-node`'s built-in caching.
    # Since we are using an explicit path and key, we use the standard action.
    - name: Restore Node Cache
      id: cache-node
      uses: actions/cache@v4
      with:
        path: blog/node_modules # Path is relative to the runner root.
        key: ${{ runner.os }}-node-${{ hashFiles('blog/package-lock.json') }}
        
    # 5. Install Node Dependencies (npm install)
    - name: Install Node Dependencies
      run: npm install
      working-directory: blog 
  
    # 6. Build Hugo Site 
    - name: Build Hugo Site
      run: |
        HUGO_VERSION=${{ vars.HUGO_VERSION || '0.148.0' }} 
        npm install -g hugo-cli
        # NOTE: If hugo-cli isn't found, you might need a separate action for Hugo.
        hugo --gc --minify --baseURL ${{ vars.CI_CF_PAGES_URL || 'https://tejasjog-blog.pages.dev/' }} --destination public-cf
      env:
        HUGO_VERSION: 0.148.0 
      working-directory: blog
        
    # 7. Install Wrangler (Globally installed)
    - name: Install Wrangler
      run: npm install -g wrangler
  
    # 8. Deploy to Cloudflare Pages
    - name: Deploy to Cloudflare Pages
      uses: cloudflare/pages-action@v1 
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: 'tejasjog-blog'
        directory: 'blog/public-cf' 
        branch: 'main'
