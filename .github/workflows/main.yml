name: Deploy Hugo Blog from GitLab to Cloudflare Pages

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Clone the Code from GitLab
      - name: Clone Code from GitLab and Setup Directory
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_ACCESS_TOKEN }} 
        run: |
          # Clone the repository. This creates the 'blog' folder in the runner's root.
          git clone https://oauth2:$GITLAB_TOKEN@gitlab.com/tejasjog/blog.git
          
          # ⚠️ FIX: REMOVED 'cd blog'

          # Run submodule update from the root, targeting the 'blog' folder
          git submodule update --init --recursive
        working-directory: blog # <-- ADDED: Run submodule update inside 'blog'

      # 2. Setup Node.js (Should run before the cache step that uses npm)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
        
      # 3. Cache Node Modules
      - name: Cache Node Modules
        uses: actions/cache@v4
        with:
          # Path must include the cloned directory name
          path: blog/node_modules 
          # Hash path must include the cloned directory name
          key: ${{ runner.os }}-node-${{ hashFiles('blog/package-lock.json') }}
          
      # 4. Install Node Dependencies (npm install)
      - name: Install Node Dependencies
        run: npm install
        # ✅ working-directory: blog now correctly points to the cloned folder
        working-directory: blog 

      # 5. Build Hugo Site 
      - name: Build Hugo Site
        run: |
          HUGO_VERSION=${{ vars.HUGO_VERSION || '0.148.0' }} 
          npm install -g hugo-cli
          hugo --gc --minify --baseURL ${{ vars.CI_CF_PAGES_URL || 'https://tejasjog-blog.pages.dev/' }} --destination public-cf
        env:
          HUGO_VERSION: 0.148.0 
        working-directory: blog
          
      # 6. Install Wrangler (Globally installed)
      - name: Install Wrangler
        run: npm install -g wrangler

      # 7. Deploy to Cloudflare Pages
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: 'tejasjog-blog'
          # Directory is relative to the runner's root
          directory: 'blog/public-cf' 
          branch: ${{ github.ref_name }}