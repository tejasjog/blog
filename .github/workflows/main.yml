name: Deploy Hugo Blog from GitLab to Cloudflare Pages

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      DART_SASS_VERSION: 1.77.4 # Define the Dart Sass version globally for the job
      HUGO_VERSION: 0.148.0 # <-- Define your desired Hugo version here
      
    steps:
    # 1. Checkout Code from GitLab (Using SSH or Token to handle submodules)
    # We combine the clone and setup steps for better access control.
    - name: Checkout Code with Submodule Authentication
      env:
        # Use a variable name that Git can easily interpret as a token
        GIT_OAUTH_TOKEN: ${{ secrets.GITLAB_ACCESS_TOKEN }} 
      run: |
        # 1a. Clone the repository first using the token
        git clone https://oauth2:$GIT_OAUTH_TOKEN@gitlab.com/tejasjog/blog.git
        
        # 1b. Change directory to the cloned repo
        cd blog
        
        # 1c. CRITICAL: Configure Git to replace all 'https://gitlab.com' 
        # URLs in the .gitmodules file with the authenticated token URL.
        # This ensures that git submodule update succeeds for private repos.
        git config --global url."https://oauth2:$GIT_OAUTH_TOKEN@gitlab.com".insteadOf "https://gitlab.com"
        
    # 2. Run Submodule Update and Cleanup .git files
    - name: Update Submodules and Cleanup Content Directories
      # working-directory must be 'blog' now
      working-directory: blog
      run: |
        echo "Attempting to update submodules..."
        # 2a. Update/initialize all submodules. This now uses the authenticated URL.
        git submodule update --init --recursive --force
  
        # 2b. CRITICAL FIX: Remove the hidden .git directories from content submodules.
        # Using -depth ensures reliable removal, which is necessary for Hugo to process the content.
        # The 'themes/PaperMod' submodule is excluded as it needs its .git directory.
        find content/posts -depth -name .git -exec rm -rf {} \;
        
        echo "Cleanup complete. Content submodules now look like regular folders."
  
    
    # NEW STEP: Install System Dependencies (Brotli and Dart Sass)
    - name: Install Brotli and Dart Sass
      # This step must run in the root of the runner before Node.js setup
      run: |
        echo "Installing system dependencies: brotli and Dart Sass..."
        
        # Install brotli
        sudo apt-get update
        sudo apt-get install -y brotli
        
        # Install Dart Sass
        # Note: We use the DART_SASS_VERSION environment variable defined above.
        DART_SASS_FILENAME="dart-sass-${{ env.DART_SASS_VERSION }}-linux-x64.tar.gz"
        curl -LJO https://github.com/sass/dart-sass/releases/download/${{ env.DART_SASS_VERSION }}/$DART_SASS_FILENAME
        tar -xf $DART_SASS_FILENAME
        
        # Move the executables to a standard PATH location
        sudo cp -r dart-sass/* /usr/local/bin/
        
        # Clean up downloaded files
        rm -rf dart-sass*
        
        # The /usr/local/bin is already in the system PATH, so an explicit export is not necessary 
        # for subsequent steps in the same job, but we'll confirm the files are there.
        echo "Dart Sass installed to /usr/local/bin"
        
    # 3. Setup Node.js 
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        
    # 4. Cache Node Modules
    # Note: Caching with /node_modules path is tricky unless using `setup-node`'s built-in caching.
    # Since we are using an explicit path and key, we use the standard action.
    - name: Restore Node Cache
      id: cache-node
      uses: actions/cache@v4
      with:
        path: blog/node_modules # Path is relative to the runner root.
        key: ${{ runner.os }}-node-${{ hashFiles('blog/package-lock.json') }}
        
    # 5. Install Node Dependencies (npm install)
    - name: Install Node Dependencies
      run: npm install
      working-directory: blog 
  
    # 6A. Setup Hugo Extended using the peaceiris action
    - name: Setup Hugo Extended
      uses: peaceiris/actions-hugo@v3
      with:
        hugo-version: '${{ env.HUGO_VERSION }}' # Uses the version defined in 'env'
        extended: true # <-- CRITICAL: This flag installs the Extended version
      working-directory: blog # Ensure this runs in the context of your 'blog' directory
    
    # 6B. Build Hugo Site
    - name: Build Hugo Site
      run: |
        # The 'hugo' command is now available on PATH from the previous step.
        hugo --gc --minify --baseURL ${{ vars.CI_CF_PAGES_URL || 'https://tejasjog-blog.pages.dev/' }} --destination public-cf
      working-directory: blog

    # 7. Install Wrangler (Globally installed)
    - name: Install Wrangler
      run: npm install -g wrangler
  
    # 8. Deploy to Cloudflare Pages
    - name: Deploy to Cloudflare Pages
      uses: cloudflare/pages-action@v1 
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: 'tejasjog-blog'
        directory: 'blog/public-cf' 
        branch: 'main'
