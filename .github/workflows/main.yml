name: Deploy Hugo Blog from GitLab to Cloudflare Pages

# This workflow runs when changes are manually triggered or pushed to the main branch
on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. üõ†Ô∏è NEW: Clone the Code from GitLab using the git clone command
      #    This securely uses your stored GitLab Access Token (PAT)
      - name: Clone Code from GitLab
        env:
          # Pass the GitHub Secret as an environment variable
          GITLAB_TOKEN: ${{ secrets.GITLAB_ACCESS_TOKEN }} 
        run: |
          # 1a. Clone the repository using the PAT for authentication
          # Format: https://oauth2:${TOKEN}@gitlab.com/owner/repo.git
          git clone https://oauth2:$GITLAB_TOKEN@gitlab.com/tejasjog/blog.git
          
          # 1b. Move into the cloned directory for subsequent steps
          # The clone command creates a directory named 'blog'
          cd blog
          
          # 1c. Set fetch-depth to 0 and pull submodules if needed (Hugo often requires this)
          # Note: The cd command above is active for this entire run block
          git fetch --unshallow || true
          git submodule update --init --recursive

      # 2. Setup Node.js (Required for npm install and Wrangler)
      #    The working directory is now inside the cloned 'blog' repo.
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      # 3. Cache Node Modules (Optional: Speeds up subsequent builds)
      - name: Cache Node Modules
        uses: actions/cache@v4
        with:
          # Path is now relative to the 'blog' directory
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      # 4. Install Node.js Dependencies (e.g., Wrangler CLI, Tailwind/PostCSS)
      - name: Install Node Dependencies
        run: npm ci

      # 5. Build Hugo Site (Custom Logic from your YAML)
      - name: Build Hugo Site
        run: |
          # ‚ö†Ô∏è Use HUGO_VERSION for GitHub to auto-install the correct extended version
          HUGO_VERSION=${{ vars.HUGO_VERSION || '0.148.0' }} 
          npm install -g hugo-cli
          # Cloudflare build URL is not automatically available, use your CI variable
          hugo --gc --minify --baseURL ${{ vars.CI_CF_PAGES_URL || 'https://tejasjog-blog.pages.dev/' }} --destination public-cf
        env:
          HUGO_VERSION: 0.148.0 
          
      # 6. Install Wrangler (Required for deployment)
      #    Wrangler is now installed globally, so the directory change doesn't matter much.
      - name: Install Wrangler
        run: npm install -g wrangler

      # 7. Deploy to Cloudflare Pages
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: 'tejasjog-blog'
          # Directory is relative to the current working directory ('blog')
          directory: 'public-cf'
          branch: ${{ github.ref_name }}