name: Deploy Hugo Blog from GitLab to Cloudflare Pages

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Clone the Code from GitLab
      - name: Clone Code from GitLab and Setup Directory
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_ACCESS_TOKEN }} 
        run: |
          # Clone the repository
          git clone https://oauth2:$GITLAB_TOKEN@gitlab.com/tejasjog/blog.git
          
          # Move into the cloned directory for the remaining steps in this block
          cd blog
          
          # üõ†Ô∏è FIX 1: Removed the unnecessary and conflicting 'git fetch --unshallow || true'
          # Pull submodules
          git submodule update --init --recursive

      # 2. Setup Node.js and Install Dependencies
      # We combine steps 2, 3, and 4 and use the 'working-directory' parameter 
      # to ensure all file-related operations run inside the 'blog' folder.
      - name: Setup Node.js and Install Dependencies
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
        
      # 3. Cache Node Modules (Runs in the runner root, path must be explicit)
      - name: Cache Node Modules
        uses: actions/cache@v4
        with:
          # üõ†Ô∏è FIX 2: Path must include the cloned directory name
          path: blog/node_modules 
          # üõ†Ô∏è FIX 3: Hash path must include the cloned directory name
          key: ${{ runner.os }}-node-${{ hashFiles('blog/package-lock.json') }}
          
      # 4. Install Node Dependencies (npm ci)
      - name: Install Node Dependencies
        run: npm ci
        # üõ†Ô∏è FIX 4: Use working-directory to ensure npm ci runs where package-lock.json is
        working-directory: blog 

      # 5. Build Hugo Site 
      - name: Build Hugo Site
        run: |
          HUGO_VERSION=${{ vars.HUGO_VERSION || '0.148.0' }} 
          # The global install path is automatically added to PATH
          npm install -g hugo-cli
          # The hugo command is run from the 'blog' directory
          hugo --gc --minify --baseURL ${{ vars.CI_CF_PAGES_URL || 'https://tejasjog-blog.pages.dev/' }} --destination public-cf
        env:
          HUGO_VERSION: 0.148.0 
        # üõ†Ô∏è FIX 5: Use working-directory for the Hugo build to find config.toml etc.
        working-directory: blog
          
      # 6. Install Wrangler (Globally installed, so directory doesn't matter)
      - name: Install Wrangler
        run: npm install -g wrangler

      # 7. Deploy to Cloudflare Pages
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: 'tejasjog-blog'
          # üõ†Ô∏è FIX 6: The directory is now relative to the runner's root
          directory: 'blog/public-cf' 
          branch: ${{ github.ref_name }}