name: Deploy Hugo Blog from GitLab to Cloudflare Pages

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Clone the Code from GitLab (Only Clone in this step)
      - name: Clone Code from GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_ACCESS_TOKEN }} 
        run: |
          # Clone the repository. This creates the 'blog' folder in the runner's root.
          git clone https://oauth2:$GITLAB_TOKEN@gitlab.com/tejasjog/blog.git

      # 2. Run Submodule Update and Checkout
      - name: Update and Checkout Submodules
        run: |
          # The clone in step 1 creates the 'blog' directory.
          # The following updates all submodules and checks out their content.
          git submodule update --init --recursive
          # Ensure all content is checked out (mostly redundant, but ensures robustness)
          git submodule foreach git checkout .
        working-directory: blog

      # 3. Setup Node.js 
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
        
      # 4. Cache Node Modules
      - name: Cache Node Modules
        uses: actions/cache@v4
        with:
          path: /node_modules 
          key: ${{ runner.os }}-node-${{ hashFiles('blog/package-lock.json') }}
          
      # 5. Install Node Dependencies (npm install)
      - name: Install Node Dependencies
        run: npm install
        working-directory: blog 

      # 6. Build Hugo Site 
      - name: Build Hugo Site
        run: |
          HUGO_VERSION=${{ vars.HUGO_VERSION || '0.148.0' }} 
          npm install -g hugo-cli
          hugo --gc --minify --baseURL ${{ vars.CI_CF_PAGES_URL || 'https://tejasjog-blog.pages.dev/' }} --destination public-cf
        env:
          HUGO_VERSION: 0.148.0 
        working-directory: blog
          
      # 7. Install Wrangler (Globally installed)
      - name: Install Wrangler
        run: npm install -g wrangler

      # 8. Deploy to Cloudflare Pages
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1 # <--- USE THE PAGES-ACTION
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: 'tejasjog-blog'
          directory: 'blog/public-cf' 
          branch: 'main'