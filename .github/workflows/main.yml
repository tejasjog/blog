name: Deploy Hugo Blog from GitLab to Cloudflare Pages

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      DART_SASS_VERSION: 1.77.4 # Define the Dart Sass version globally for the job
      HUGO_VERSION: 0.148.0 # <-- Define your desired Hugo version here
      
    steps:
    # 1. Checkout Code from GitLab (Using SSH or Token to handle submodules)
    # We combine the clone and setup steps for better access control.
    - name: Checkout Code with Submodule Authentication
      env:
        # Use a variable name that Git can easily interpret as a token
        GIT_OAUTH_TOKEN: ${{ secrets.GITLAB_ACCESS_TOKEN }} 
      run: |
        # 1a. Clone the repository first using the token
        git clone --depth 0 https://oauth2:$GIT_OAUTH_TOKEN@gitlab.com/tejasjog/blog.git
        
        # 1b. Change directory to the cloned repo
        cd blog
        
        # 1c. CRITICAL: Configure Git to replace all 'https://gitlab.com' 
        # URLs in the .gitmodules file with the authenticated token URL.
        # This ensures that git submodule update succeeds for private repos.
        git config --global url."https://oauth2:$GIT_OAUTH_TOKEN@gitlab.com".insteadOf "https://gitlab.com"
        
    # 2. Run Submodule Update and Cleanup .git files
    - name: Update Submodules and Cleanup Content Directories
      # working-directory must be 'blog' now
      working-directory: blog
      run: |
        echo "Attempting to update submodules..."
        # 2a. Update/initialize all submodules. This now uses the authenticated URL.
        git submodule update --init --recursive --force

        echo "## ðŸ“Š File Count Per Directory ##"
        echo "--------------------------------"
        
        # Find all directories (excluding the main .git folder)
        # The -path ./.git -prune part tells find to ignore the Git metadata directory.
        find . -path ./.git -prune -o -type d -print | while read dir; do
            
            # Use find again to count only files (-type f) within that specific directory ($dir)
            # The '2>/dev/null' suppresses any potential permission errors.
            file_count=$(find "$dir" -maxdepth 1 -type f 2>/dev/null | wc -l)
            
            # Print the count and the directory name.
            # The '{print $0}' ensures the directory name is used exactly as read.
            if [ "$file_count" -gt 0 ]; then
                echo "$file_count files in: $dir"
            fi
        done
        echo "--------------------------------"
        
        # Optional: Keep your original total count for comparison
        echo "Total files in repository (excluding .git):"
        find . -path ./.git -prune -o -type f -print | wc -l

    # NEW STEP: Install System Dependencies (Brotli and Dart Sass)
    - name: Install Brotli and Dart Sass
      # This step must run in the root of the runner before Node.js setup
      run: |
        echo "Installing system dependencies: brotli and Dart Sass..."
        
        # Install brotli
        sudo apt-get update
        sudo apt-get install -y brotli
        
        # Install Dart Sass
        # Note: We use the DART_SASS_VERSION environment variable defined above.
        DART_SASS_FILENAME="dart-sass-${{ env.DART_SASS_VERSION }}-linux-x64.tar.gz"
        curl -LJO https://github.com/sass/dart-sass/releases/download/${{ env.DART_SASS_VERSION }}/$DART_SASS_FILENAME
        tar -xf $DART_SASS_FILENAME
        
        # Move the executables to a standard PATH location
        sudo cp -r dart-sass/* /usr/local/bin/
        
        # Clean up downloaded files
        rm -rf dart-sass*
        
        # The /usr/local/bin is already in the system PATH, so an explicit export is not necessary 
        # for subsequent steps in the same job, but we'll confirm the files are there.
        echo "Dart Sass installed to /usr/local/bin"
        
        # Install Hugo
        sudo curl -LJO https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb
        sudo apt-get install -y ./hugo_extended_${HUGO_VERSION}_linux-amd64.deb
        sudo rm hugo_extended_${HUGO_VERSION}_linux-amd64.deb

        # Install Node.js
        sudo curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION} | bash -
        sudo apt-get install -y nodejs

    # 5. Install Node Dependencies (npm install)
    - name: Install Node Dependencies
      run: npm install
      working-directory: blog 
        
    # 6B. Build Hugo Site
    - name: Build Hugo Site
      run: |
        # The 'hugo' command is now available on PATH from the previous step.
        hugo --gc --minify --baseURL ${{ vars.CI_CF_PAGES_URL || 'https://tejasjog-blog.pages.dev/' }} --destination public-cf --logLevel debug --environment production
      working-directory: blog

    # 7. Install Wrangler (Globally installed)
    - name: Install Wrangler
      run: npm install -g wrangler
  
    # 8. Deploy to Cloudflare Pages
    - name: Deploy to Cloudflare Pages
      uses: cloudflare/pages-action@v1 
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: 'tejasjog-blog'
        directory: 'blog/public-cf' 
        branch: 'main'
